#!/usr/bin/env bash

red='\033[1;31m'
green='\033[1;32m'
yellow='\033[1;33m'
cyan='\033[1;36m'
nc='\033[0m'
bold='\033[1m'

project="cpp-first-app"
build_dir="build"

show_help() {
    echo -e "${bold}üöÄ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]${nc}"
    echo -e "${cyan}–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:${nc}"
    echo "  ${green}setup${nc}    [--release]  üèóÔ∏è  —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å–±–æ—Ä–∫–∏"
    echo "  ${green}build${nc}               üîß —Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç"
    echo "  ${green}run${nc}                 ‚ñ∂Ô∏è  —Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å"
    echo "  ${green}clean${nc}               üßπ –æ—á–∏—Å—Ç–∏—Ç—å –æ–±—ä–µ–∫—Ç–Ω—ã–µ —Ñ–∞–π–ª—ã"
    echo "  ${green}purge${nc}               üí• –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å —Å–±–æ—Ä–∫—É"
    echo "  ${green}config${nc} [–æ–ø—Ü–∏–∏]      ‚öôÔ∏è  –∏–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
    echo "  ${green}install${nc}             üì¶ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"
    echo "  ${green}help${nc}                ‚ÑπÔ∏è  –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo -e "\n${yellow}–ø—Ä–∏–º–µ—Ä—ã:${nc}"
    echo "  $0 setup --release"
    echo "  $0 config --buildtype=release -dcpp_std=c++23"
    echo "  $0 run"
}

run_setup() {
    echo -e "${cyan}üèóÔ∏è  –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏...${nc}"

    local build_type="debug"
    [[ "$*" == *"--release"* ]] && build_type="release"

    meson setup "$build_dir" --buildtype="$build_type" "$@"

    if [ $? -eq 0 ]; then
        echo -e "${green}‚úÖ –≥–æ—Ç–æ–≤–æ! —Ç–∏–ø —Å–±–æ—Ä–∫–∏: $build_type${nc}"
    else
        echo -e "${red}‚ùå –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏!${nc}"
        exit 1
    fi
}

run_build() {
    echo -e "${cyan}üîß –∫–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞...${nc}"
    meson compile -C "$build_dir"

    if [ $? -eq 0 ]; then
        echo -e "${green}‚úÖ —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${nc}"
        echo -e "üíæ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª: ${bold}$build_dir/$project${nc}"
    else
        echo -e "${red}‚ùå –æ—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏!${nc}"
        exit 1
    fi
}

run_config() {
    echo -e "${cyan}‚öôÔ∏è  –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏...${nc}"
    meson configure "$build_dir" "$@"

    if [ $? -eq 0 ]; then
        echo -e "${green}‚úÖ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!${nc}"
        meson configure "$build_dir" | grep -e 'buildtype|cpp_std|warning_level'
    else
        echo -e "${red}‚ùå –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏!${nc}"
        exit 1
    fi
}

run_install() {
    echo -e "${cyan}üì¶ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã...${nc}"
    (cd "$build_dir" && sudo meson install)
    echo -e "${green}‚úÖ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!${nc}"
}

case "$1" in
setup)
    shift
    run_setup "$@"
    ;;
build)
    run_build
    ;;
run)
    run_build
    echo -e "\n${cyan}‚ñ∂Ô∏è  –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã...${nc}"
    echo "----------------------"
    "./$build_dir/$project"
    ;;
clean)
    echo -e "${cyan}üßπ –æ—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...${nc}"
    ninja -c "$build_dir" clean
    ;;
purge)
    echo -e "${cyan}üí• —É–¥–∞–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–±–æ—Ä–∫–∏...${nc}"
    rm -rfv "$build_dir"
    ;;
config)
    shift
    run_config "$@"
    ;;
install)
    run_install
    ;;
help)
    show_help
    ;;
*)
    echo -e "${red}‚ùå –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1${nc}"
    show_help
    exit 1
    ;;
esac
